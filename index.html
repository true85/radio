<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>타임시프트 라디오 (VOD)</title>

  <!-- Video.js 최신 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/video.js@8/dist/video-js.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/video.js@8/dist/video.min.js"></script>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" />

  <style>
    :root { --primary:#007aff; --bg:#f4f4f8; --fg:#333; --label:#555; --border:#e0e0e0; }
    *{box-sizing:border-box;}
    body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--fg);display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;padding:20px;}
    .wrap{background:#fff;padding:32px 40px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.1);max-width:700px;width:100%;text-align:center;}
    h1{margin:0 0 20px;font-size:2em;color:var(--primary);}
    .controls{display:grid;grid-template-columns:1fr 2fr auto;gap:16px;align-items:end;margin-bottom:24px;}
    .control-group{display:flex;flex-direction:column;text-align:left;}
    label{font-weight:500;color:var(--label);margin-bottom:6px;}
    select{padding:10px;border:1px solid var(--border);border-radius:8px;font:inherit;}
    #play-btn{padding:11px 20px;border:none;border-radius:10px;font-weight:600;color:#fff;background:var(--primary);cursor:pointer;height:40px;}
    #status{margin-top:12px;font-style:italic;color:#888;min-height:20px;}
    .video-js{width:100%;height:56px;border-radius:12px;overflow:hidden;background:#222;margin-top:20px;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>타임시프트 라디오 (다시듣기)</h1>

    <div class="controls">
      <div class="control-group">
        <label for="station">방송국</label>
        <select id="station">
          <option value="sbs">SBS 파워FM</option>
          <option value="kbs">KBS Cool FM (2FM)</option>
        </select>
      </div>
      <div class="control-group">
        <label for="program">프로그램</label>
        <select id="program"></select>
      </div>
      <button id="play-btn">▶ 재생</button>
    </div>

    <div id="status"></div>

    <video id="player" class="video-js vjs-big-play-centered" controls preload="auto"></video>
  </div>

<script>
/* global videojs */
const schedule={
  sbs:{prefix:'sbs/powerfm',programs:[
    {name:'김영철의 파워FM',time:'07:00'},
    {name:'아름다운 이 아침 김창완입니다',time:'09:00'},
    {name:'박하선의 씨네타운',time:'11:00'},
    {name:'최화정의 파워타임',time:'12:00'},
    {name:'두시탈출 컬투쇼',time:'14:00'},
    {name:'딘딘의 Music High',time:'23:00'}]},
  kbs:{prefix:'kbs/25',programs:[
    {name:'조정식의 FM대행진',time:'07:00'},
    {name:'이현우의 음악앨범',time:'09:00'},
    {name:'박명수의 라디오쇼',time:'11:00'},
    {name:'이은지의 가요광장',time:'12:00'},
    {name:'윤정수 남창희의 미스터 라디오',time:'16:00'},
    {name:'사랑하기 좋은 날 이금희입니다',time:'18:00'}]}
};

// 요소 선택
const selStation=document.getElementById('station');
const selProgram=document.getElementById('program');
const playBtn=document.getElementById('play-btn');
const status=document.getElementById('status');

// 프로그램 목록 채우기
function fillPrograms(){
  const list=schedule[selStation.value].programs;
  selProgram.innerHTML='';
  list.forEach(p=>{
    const opt=document.createElement('option');
    opt.value=p.time;
    opt.textContent=`${p.time} - ${p.name}`;
    selProgram.appendChild(opt);
  });
}
selStation.addEventListener('change',fillPrograms);
fillPrograms();

// video.js 초기화
const player=videojs('player');

function playProgram(){
  const key=selStation.value;
  const prefix=schedule[key].prefix;
  const [h,m]=selProgram.value.split(':').map(Number);

  const now=new Date();
  const kstOffset=9*60*60*1000; // KST → UTC

  // 오늘(브라우저 기준) 00:00 KST 를 UTC 타임스탬프로 계산
  const todayKST=new Date(now.getTime()+kstOffset);
  const startOfDayUTC=Date.UTC(todayKST.getUTCFullYear(),todayKST.getUTCMonth(),todayKST.getUTCDate());

  // 선택 프로그램 시작 시각 (오늘 날짜 기준 KST)
  let progStartUTC=startOfDayUTC+(h*60+m)*60*1000-kstOffset;

  // 과거 방송 처리: diff 음수면 하루 전으로 이동
  let diff=now.getTime()-progStartUTC;
  if(diff<0){
    progStartUTC-=24*60*60*1000;
    diff=now.getTime()-progStartUTC;
  }

  if(diff<0){
    status.textContent='아직 방송이 시작되지 않았어요.';
    return;
  }

  const ago=Math.round(diff/1000)+'s';
  const src=`https://radio-timeshift-shift.dbr666v.workers.dev/${prefix}.m3u8?ago=${ago}`;
  status.textContent=`${selProgram.options[selProgram.selectedIndex].textContent} 재생 중...`;
  player.src({src,type:'application/x-mpegURL'});
  player.play();
}

playBtn.addEventListener('click',playProgram);
</script>
</body>
</html>
