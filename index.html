<!-- radio-timeshift-ui.html (v7.1)
     ✓ MEDIA-SEGMENT 진행 버그 / JSON parse 오류 수정
     ✓ Video.js 8 + VHS 기본
-->
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Timeshift Radio Player</title>

    <!-- video.js 8 (VHS 포함) -->
    <link href="https://vjs.zencdn.net/8.3.0/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/8.3.0/video.min.js"></script>

    <style>
      :root {
        --bg: #000;
        --fg: #fff;
        --panel: #111;
        --border: #333;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--fg);
        height: 100vh;
        display: flex;
        flex-direction: column;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      }
      #controls {
        background: var(--panel);
        padding: 8px 12px;
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
        font-size: 14px;
        border-bottom: 1px solid var(--border);
      }
      select {
        background: #222;
        color: var(--fg);
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 14px;
      }
      #error { color: #f44336; font-size: 12px; }
      video { width: 100%; height: 100%; background: #000; }
    </style>
  </head>
  <body>
    <!-- ▶ 컨트롤 패널 -->
    <div id="controls">
      <label for="stream">방송:</label>
      <select id="stream">
        <optgroup label="KBS">
          <option value="kbs:25">KBS 1 Radio</option>
        </optgroup>
        <optgroup label="SBS">
          <option value="sbs:powerfm">파워FM</option>
        </optgroup>
      </select>

      <label for="ago">시점:</label>
      <select id="ago">
        <option value="5m">5 분 전</option>
        <option value="10m">10 분 전</option>
        <option value="6h" selected>6 시간 전</option>
        <option value="7h">7 시간 전</option>
        <option value="8h">8 시간 전</option>
        <option value="9h">9 시간 전</option>
      </select>

      <span id="error"></span>
    </div>

    <!-- ▶ Player -->
    <video id="player" class="video-js vjs-default-skin" controls preload="auto" playsinline crossorigin="anonymous"></video>

    <script>
      const SHIFT = "https://radio-timeshift-shift.dbr666v.workers.dev/shift";
      const $stream = document.getElementById("stream");
      const $ago    = document.getElementById("ago");
      const $error  = document.getElementById("error");
      const player  = videojs("player");

      // 🔸 buildURL 은 /shift/{span}/{type}/{ch}.m3u8 형식 사용
      const buildURL = () => {
        const [type, ch] = $stream.value.split(":");
        return `${SHIFT}/${$ago.value}/${type}/${ch}.m3u8`;
      };

      const humanError = err => {
        switch ((err?.code) ?? -1) {
          case 4: return "재생할 수 없는 미디어 (404/403)";
          case 2: return "네트워크 오류 (세그먼트 누락)";
          default: return "재생 오류";
        }
      };

      /* ─────────── main ─────────── */
      player.ready(() => {
        // 복원
        const savedStream = localStorage.getItem("stream");
        const savedAgo    = localStorage.getItem("ago");
        if (savedStream) $stream.value = savedStream;
        if (savedAgo)    $ago.value    = savedAgo;

        const setSource = () => {
          localStorage.setItem("stream", $stream.value);
          localStorage.setItem("ago",    $ago.value);

          $error.textContent = "";
          player.reset(); // 진입점 리셋 ✨
          player.src({ src: buildURL(), type: "application/x-mpegURL" });
          player.play().catch(() => {
            $error.textContent = "브라우저가 자동 재생을 차단했습니다. ▶ 버튼을 눌러 주세요.";
          });
        };

        setSource();
        player.on("error", () => { $error.textContent = humanError(player.error()); });
        $stream.addEventListener("change", setSource);
        $ago.addEventListener("change",    setSource);
      });
    </script>
  </body>
</html>
